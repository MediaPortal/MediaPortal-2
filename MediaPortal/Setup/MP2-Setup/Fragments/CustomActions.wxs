<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>
    <Binary Id="Custom_Action_Dll" SourceFile="$(var.CustomActions.TargetDir)CustomActions.CA.dll"/>

    <CustomAction Id="ReadCustomPathsFromExistingPathsFile" BinaryKey="Custom_Action_Dll" DllEntry="ReadCustomPathsFromExistingPathsFile" Execute="immediate" Return="check" />
    <CustomAction Id="PrepareXmlPathVariables" BinaryKey="Custom_Action_Dll" DllEntry="PrepareXmlPathVariables" Execute="immediate" Return="check" />

    <CustomAction Id="AttachClientToServer" BinaryKey="Custom_Action_Dll" DllEntry="AttachClientToServer" Execute="immediate" Return="check" />

    <CustomAction Id="StopProcesses" BinaryKey="Custom_Action_Dll" DllEntry="StopProcesses" Impersonate="no" Execute="immediate" Return="ignore" />

    <!-- Use WixQuietExec to run the commands to avoid the command window popping up. The command line to run needs to be stored
         in a property with the same id as the WixQuietExec custom action and the path to the exe needs to be quoted.
         A SetProperty action is used to allow the [SystemFolder] reference to be resolved and needs to be scheduled to run before the action.-->
    <SetProperty Id="ListenerServiceAddReservation"
                 Value="&quot;[SystemFolder]netsh.exe&quot; http add urlacl url=http://+:55555/MediaPortal/ sddl=D:(A;;GX;;;S-1-1-0)"
                 Before="ListenerServiceAddReservation"
                 Sequence="execute" />
    <CustomAction Id="ListenerServiceAddReservation"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="asyncWait" />

    <SetProperty Id="ListenerServiceDeleteReservation"
                 Value="&quot;[SystemFolder]netsh.exe&quot; http delete urlacl url=http://+:55555/MediaPortal/"
                 Before="ListenerServiceDeleteReservation"
                 Sequence="execute" />
    <CustomAction Id="ListenerServiceDeleteReservation"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="asyncWait" />

    <SetProperty Id="FirewallPortAdd"
                 Value="&quot;[SystemFolder]netsh.exe&quot; advfirewall firewall add rule name=&quot;MediaPortal UPnP/HttpServer&quot; dir=in action=allow protocol=TCP localport=55555"
                 Before="FirewallPortAdd"
                 Sequence="execute" />
    <CustomAction Id="FirewallPortAdd"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="asyncWait" />

    <SetProperty Id="FirewallPortRemove"
                 Value="&quot;[SystemFolder]netsh.exe&quot; advfirewall firewall delete rule name=&quot;MediaPortal UPnP/HttpServer&quot; protocol=TCP localport=55555"
                 Before="FirewallPortRemove"
                 Sequence="execute" />
    <CustomAction Id="FirewallPortRemove"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="asyncWait" />

    <InstallExecuteSequence>
      <Custom Action="ListenerServiceDeleteReservation" Before="InstallFinalize">Installed</Custom>
      <Custom Action="ListenerServiceAddReservation" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="FirewallPortRemove" Before="InstallFinalize">Installed</Custom>
      <Custom Action="FirewallPortAdd" Before="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>
